<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<title> cargo-semver-checks lint configuration guide   | max's blog</title>
		<link rel="stylesheet" href="/base.css" />
	</head>
	<body class="light">
		<div id="content">
			<header>
				<a href="/">max's blog</a>
				 &gt;
<a class="title" href="https://blog.mcarr.one/csc-config-guide/">cargo-semver-checks lint configuration guide</a>

			</header>
			<article>
				
<h2 id="subtitle">
    <span class="date">2024-07-18</span>
     | tags:
    <ul id="tags">
        
        <li><a href="/tags/gsoc24">gsoc24</a></li>
        
        <li><a href="/tags/rust">rust</a></li>
        
    </ul>
    
</h2>


<div id="show-toc">
    <input id="show-toc-box" type="checkbox" />
    <label for="show-toc-box">outline</label>
</div>
<div id="toc">
    <ol>
        
        <li>
            <a href="https://blog.mcarr.one/csc-config-guide/#definitions">definitions</a>
            
        </li>
        
        <li>
            <a href="https://blog.mcarr.one/csc-config-guide/#configuring-checks">configuring checks</a>
            
        </li>
        
        <li>
            <a href="https://blog.mcarr.one/csc-config-guide/#configuring-a-workspace">configuring a workspace</a>
            
            <ol>
                
                <li>
                    <a href="https://blog.mcarr.one/csc-config-guide/#overriding-workspace-configuration"
                        >overriding workspace configuration</a
                    >
                </li>
                
            </ol>
            
        </li>
        
        <li>
            <a href="https://blog.mcarr.one/csc-config-guide/#limitations">limitations</a>
            
        </li>
        
    </ol>
</div>
 

<div id="page"><p>Recently, I've added functionality to <code>cargo-semver-checks</code> to control both the lint level and required semver update for each check.</p>
<h2 id="definitions">definitions</h2>
<ul>
<li><strong>check/lint</strong> - <code>cargo-semver-checks</code> runs many checks between versions of a crate's public API, which each check for one specific semver-breaking behavior.  For example, the <code>function_missing</code> lint is triggered when a function in the crate's public API is removed in a new version. </li>
<li><strong>lint level</strong> - For each of these checks, it is now possible to configure the level of severity for when this check occurs.  <code>deny</code> means it is a hard error when the check finds breaking behavior, which will require a version bump to resolve.  <code>warn</code> still runs the check and reports findings, but it is only a warning if it triggers and does not require (but it does suggest) a version bump.  <code>allow</code> means that the breaking behavior in this check is allowed in the code, so the check doesn't need to be run.</li>
<li><strong>required (semver) update</strong> - what version bump this check should require (for <code>deny</code>-level) or suggest (for <code>warn</code>) when the check is triggered.  For example, <code>function_missing</code> is <code>major</code> by default, so if a public function is removed between versions, the version needs a major version bump (e.g., 1.2.3 to 2.0.0 or 0.5.2 to 0.6.0).  This can be configured to <code>major</code> or <code>minor</code> (1.2.3 to 1.3.0 or 0.5.2 to 0.5.3).</li>
</ul>
<h2 id="configuring-checks">configuring checks</h2>
<p>To configure the level and/or required update for a check, first find its id.  This will be in <code>snake_case</code> and is reported on error/warning or found as the file name in the <a href="https://github.com/obi1kenobi/cargo-semver-checks/tree/main/src/lints">lints folder</a>.  Let's use <code>function_missing</code> as an example.</p>
<p>Then, determine what the new lint level and/or required version update should be.  For our example, let's set the level to <code>warn</code> and the required update to <code>minor</code>.</p>
<p>In the <code>Cargo.toml</code> manifest for the crate we're checking, add the <code>cargo-semver-checks</code> lints table:</p>
<pre data-lang="toml" style="background-color:#2b303b;color:#c0c5ce;" class="language-toml "><code class="language-toml" data-lang="toml"><span style="color:#65737e;"># ...
</span><span>[package.metadata.cargo-semver-checks.lints]
</span><span style="color:#bf616a;">function_missing </span><span>= { </span><span style="color:#bf616a;">level </span><span>= &quot;</span><span style="color:#a3be8c;">warn</span><span>&quot;, </span><span style="color:#bf616a;">required-update </span><span>= &quot;</span><span style="color:#a3be8c;">minor</span><span>&quot; }
</span></code></pre>
<p>To configure other lints, just add them as additional entries to that table.  Note that it is not required to configure <em>both</em> lint level and required version update, and you can use the shorthand <code>lint_id = &quot;level&quot;</code> to configure just the lint level:</p>
<pre data-lang="toml" style="background-color:#2b303b;color:#c0c5ce;" class="language-toml "><code class="language-toml" data-lang="toml"><span>[package.metadata.cargo-semver-checks.lints]
</span><span style="color:#bf616a;">function_missing </span><span>= { </span><span style="color:#bf616a;">level </span><span>= &quot;</span><span style="color:#a3be8c;">warn</span><span>&quot;, </span><span style="color:#bf616a;">required-update </span><span>= &quot;</span><span style="color:#a3be8c;">minor</span><span>&quot; }
</span><span style="color:#bf616a;">trait_now_doc_hidden </span><span>= &quot;</span><span style="color:#a3be8c;">allow</span><span>&quot; </span><span style="color:#65737e;"># shorthand to set just lint level to `allow`
</span><span style="color:#bf616a;">enum_variant_added </span><span>= { </span><span style="color:#bf616a;">level </span><span>= &quot;</span><span style="color:#a3be8c;">deny</span><span>&quot; } </span><span style="color:#65737e;"># leaves required-update as the default
</span><span style="color:#bf616a;">function_changed_abi </span><span>= { </span><span style="color:#bf616a;">required-update </span><span>= &quot;</span><span style="color:#a3be8c;">minor</span><span>&quot; } </span><span style="color:#65737e;"># leaves level as default
</span></code></pre>
<p>This table should be placed in the current/new <code>Cargo.toml</code> manifest, not the baseline/old manifest.  (this defaults to <code>./Cargo.toml</code> in the directory that <code>cargo-semver-checks</code> was invoked on, and can be configured to a different path with the <code>--manifest-path</code> CLI option).</p>
<h2 id="configuring-a-workspace">configuring a workspace</h2>
<p>It may also be helpful to configure these checks at the workspace level for multiple different crates in the same Cargo workspace. To do this, in the workspace root <code>Cargo.toml</code>, add a similar configuration table:</p>
<pre data-lang="toml" style="background-color:#2b303b;color:#c0c5ce;" class="language-toml "><code class="language-toml" data-lang="toml"><span>[workspace.metadata.cargo-semver-checks.lints]
</span><span style="color:#bf616a;">function_missing </span><span>= { </span><span style="color:#bf616a;">level </span><span>= &quot;</span><span style="color:#a3be8c;">warn</span><span>&quot;, </span><span style="color:#bf616a;">required-update </span><span>= &quot;</span><span style="color:#a3be8c;">minor</span><span>&quot; }
</span></code></pre>
<p>Note that it is <code>workspace.metadata</code> and not <code>package.metadata</code>.  Then, to opt-in to these for each package that is being semver-checked, one of these keys to the <em>package</em> Cargo.toml:</p>
<pre data-lang="toml" style="background-color:#2b303b;color:#c0c5ce;" class="language-toml "><code class="language-toml" data-lang="toml"><span>[lints]
</span><span style="color:#bf616a;">workspace </span><span>= </span><span style="color:#d08770;">true
</span></code></pre>
<p>or </p>
<pre data-lang="toml" style="background-color:#2b303b;color:#c0c5ce;" class="language-toml "><code class="language-toml" data-lang="toml"><span>[package.metadata.cargo-semver-checks.lints]
</span><span style="color:#bf616a;">workspace </span><span>= </span><span style="color:#d08770;">true
</span></code></pre>
<p>Either of these is acceptable to indicate to read the <code>[workspace.metadata.cargo-semver-checks.lints]</code> table for this package.  Using the <code>lints.workspace</code> key can be helpful to indicate this behavior for other linters (e.g., cargo and clippy), but will cause a cargo error if it is set and there is no <code>[workspace.lints]</code> table in the workspace Cargo.toml.  To solve this, we added the <code>package.metadata.cargo-semver-checks.lints.workspace</code> key for compatibility. Note that setting <code>workspace = false</code> is not valid configuration for either of these keys.  To indicate not to read workspace configuration for a crate, simply omit both keys entirely from the package's Cargo.toml.</p>
<h3 id="overriding-workspace-configuration">overriding workspace configuration</h3>
<p>When <code>workspace = true</code> is set, it is possible to override individual lint configuration lines in a package.  For example, if we have in the <em>workspace</em> Cargo.toml:</p>
<pre data-lang="toml" style="background-color:#2b303b;color:#c0c5ce;" class="language-toml "><code class="language-toml" data-lang="toml"><span>[workspace.metadata.cargo-semver-checks.lints]
</span><span style="color:#bf616a;">function_missing </span><span>= { </span><span style="color:#bf616a;">level </span><span>= &quot;</span><span style="color:#a3be8c;">warn</span><span>&quot;, </span><span style="color:#bf616a;">required-update </span><span>= &quot;</span><span style="color:#a3be8c;">minor</span><span>&quot; }
</span><span style="color:#bf616a;">trait_now_doc_hidden </span><span>= &quot;</span><span style="color:#a3be8c;">warn</span><span>&quot;
</span></code></pre>
<p>and in the <em>package</em> Cargo.toml:</p>
<pre data-lang="toml" style="background-color:#2b303b;color:#c0c5ce;" class="language-toml "><code class="language-toml" data-lang="toml"><span>[package.metadata.cargo-semver-checks.lints]
</span><span style="color:#bf616a;">workspace </span><span>= </span><span style="color:#d08770;">true
</span><span style="color:#bf616a;">function_missing </span><span>= &quot;</span><span style="color:#a3be8c;">deny</span><span>&quot;
</span><span style="color:#bf616a;">trait_now_doc_hidden </span><span>= { </span><span style="color:#bf616a;">required-update </span><span>= &quot;</span><span style="color:#a3be8c;">major</span><span>&quot; }
</span></code></pre>
<p>Fields set in the package configuration override the workspace configuration.  Thus, the lint level for <code>function_missing</code> will be overridden to <code>deny</code>, and the workspace default <code>required-update</code> of <code>minor</code> will be used because it is not configured in the package.  Similarly, the lint level for <code>trait_now_doc_hidden</code> will be the workspace's <code>warn</code>, but the required update will be overridden in the package to a <code>major</code> version bump.</p>
<h2 id="limitations">limitations</h2>
<p>Currently, the configuration can only be read from the new version of the checked crate's Cargo.toml.  If this manifest isn't used (for example, when using the <code>--current-rustdoc</code> to use a preexisting rustdoc output instead, it is not possible to configure lints.  Configuration through other means (e.g., CLI flags) could be added in the future if there is a strong demand for them.</p>
</div>

			</article>
			<footer>
				<p>
				<span id="heart">&lt;3</span> - <a href="https://github.com/suaviloquence/blog" target="_blank">source</a>
				</p>
			</footer>
		</div>
	</body>
</html>

